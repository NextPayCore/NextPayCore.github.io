<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firmware Check Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .table-container {
            margin-top: 20px;
        }
        .status-badge {
            font-size: 0.8em;
        }
        .serial-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }
        .loading {
            display: none;
        }
        .alert-info {
            margin-bottom: 20px;
        }
        .highlight-duplicate {
            background-color: #fff3cd !important;
            border: 2px solid #ffc107 !important;
            animation: pulse-highlight 0.5s ease-in-out;
        }
        @keyframes pulse-highlight {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .toast-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            min-width: 400px;
            max-width: 600px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            animation: toastSlideIn 0.3s ease-out;
            font-size: 22px;
            font-weight: 600;
            text-align: center;
            padding: 30px;
        }
        .toast-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .toast-message {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .toast-serial {
            font-size: 20px;
            font-weight: 500;
            opacity: 0.9;
        }
        .toast-notification.alert-success {
            background-color: #d1edff !important;
            border-color: #0d6efd !important;
            color: #0d6efd !important;
        }
        .toast-notification.alert-success .toast-icon {
            color: #0d6efd !important;
        }
        .toast-notification.alert-success .toast-message {
            color: #0d6efd !important;
        }
        .toast-notification.alert-success .toast-serial {
            color: #0d6efd !important;
        }
        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        .toast-notification.fade-out {
            animation: toastFadeOut 0.3s ease-in forwards;
        }
        @keyframes toastFadeOut {
            from {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center my-4">
                    <i class="fas fa-microchip"></i> Firmware Check Tool
                </h1>
                
                <!-- <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Hướng dẫn sử dụng:</strong> Nhấn chuột vào page để focus vào document, quét mã vạch thiết bị để kiểm tra firmware. Serial thiết bị bắt đầu bằng "TB" và có 13 ký tự. Hệ thống sẽ tự động kiểm tra.
                </div> -->

                <!-- Hidden input for barcode scanner -->
                <input type="text" class="serial-input" id="serialInput" placeholder="Scan barcode here...">

                <div class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>Danh sách thiết bị</h3>
                        <div class="d-flex align-items-center gap-3">
                            <button class="btn btn-danger" id="clearAllBtn" onclick="clearAllData()">
                                <i class="fas fa-trash-alt"></i> Clear all
                            </button>
                            <button class="btn btn-success" id="exportJsonBtn" onclick="exportToJson()">
                                <i class="fas fa-download"></i> Export JSON
                            </button>
                            <button class="btn btn-warning" id="recheckAllOutdatedBtn" onclick="recheckAllOutdated()">
                                <i class="fas fa-sync-alt"></i> Recheck all outdated
                            </button>
                            <div class="loading">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                Đang kiểm tra...
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="deviceTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>STT</th>
                                    <th>Serial</th>
                                    <th>Firmware</th>
                                    <th>Is Latest</th>
                                    <th>Last Update</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="deviceTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Chưa có thiết bị nào được quét. Hãy quét mã vạch để bắt đầu.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function() {
            // Global variables
            let deviceData = [];
            let inputTimeout = null;
            const STORAGE_KEY = 'firmware_check_devices';
            const LATEST_FIRMWARE = '1.2.0.3';
            const API_BASE_URL = 'https://tingbox-ota.nextpay.vn/deviceapi/version';

            // Initialize app
            init();

            function init() {
                loadDataFromStorage();
                renderTable();
                setupBarcodeListener();
            }

            // Setup barcode scanner listener with debounce
            function setupBarcodeListener() {
                let inputBuffer = '';
                let lastInputTime = 0;
                const DEBOUNCE_TIME = 500; // 0.5 seconds

                $(document).on('keypress', function(e) {
                    const currentTime = Date.now();
                    
                    // Handle Enter key - process immediately if we have 13 characters
                    if (e.which === 13 || e.keyCode === 13) {
                        e.preventDefault();
                        if (inputBuffer.length === 13) {
                            processScannedSerial(inputBuffer);
                        } else {
                            showAlert(`Serial không đủ 13 ký tự. Hiện tại: ${inputBuffer.length} ký tự`, 'warning');
                        }
                        inputBuffer = '';
                        return;
                    }
                    
                    // Reset buffer if too much time has passed
                    if (currentTime - lastInputTime > DEBOUNCE_TIME) {
                        inputBuffer = '';
                    }
                    
                    inputBuffer += e.key;
                    lastInputTime = currentTime;
                    
                    // Clear previous timeout
                    if (inputTimeout) {
                        clearTimeout(inputTimeout);
                    }
                    
                    // Set new timeout for debounce
                    inputTimeout = setTimeout(function() {
                        // Only process if we have exactly 13 characters
                        if (inputBuffer.length === 13) {
                            processScannedSerial(inputBuffer);
                        }
                        inputBuffer = '';
                    }, DEBOUNCE_TIME);
                });
            }

            // Process scanned serial number
            function processScannedSerial(serial) {
                // Clean the serial (remove any non-printable characters)
                serial = serial.trim().replace(/[^\x20-\x7E]/g, '');
                
                // Log serial to console
                console.log('Serial thiết bị được quét:', serial);
                
                // Validate serial format (TB + 11 digits = 13 characters total)
                if (!isValidSerial(serial)) {
                    console.log('Serial không hợp lệ:', serial);
                    showAlert('Serial không hợp lệ. Serial phải bắt đầu bằng "TB" và có 13 ký tự.', 'warning');
                    return;
                }
                
                // Check if device already exists
                if (deviceExists(serial)) {
                    console.log('Thiết bị đã tồn tại, sẽ kiểm tra lại:', serial);
                    showAlert(`Thiết bị ${serial} đã tồn tại, đang kiểm tra lại firmware...`, 'info');
                    highlightDuplicateRow(serial);
                    // Continue to check firmware instead of returning
                } else {
                    console.log('Bắt đầu kiểm tra firmware cho serial:', serial);
                }
                
                // Show loading and call API
                showLoading(true);
                checkFirmware(serial);
            }

            // Validate serial number format
            function isValidSerial(serial) {
                return /^TB\d{11}$/.test(serial);
            }

            // Check if device already exists
            function deviceExists(serial) {
                return deviceData.some(device => device.serial === serial);
            }

            // Highlight duplicate row
            function highlightDuplicateRow(serial) {
                // Find the row containing the duplicate serial
                const rows = $('#deviceTableBody tr');
                rows.each(function() {
                    const row = $(this);
                    const serialCell = row.find('code').text();
                    if (serialCell === serial) {
                        // Add highlight class
                        row.addClass('highlight-duplicate');
                        
                        // Scroll to the row
                        row[0].scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                        
                        // Remove highlight after 2 seconds
                        setTimeout(() => {
                            row.removeClass('highlight-duplicate');
                        }, 2000);
                        
                        console.log('Highlighted duplicate row for serial:', serial);
                        return false; // Break the loop
                    }
                });
            }

            // Call API to check firmware
            function checkFirmware(serial) {
                console.log('Calling API for serial:', serial);
                $.ajax({
                    url: `${API_BASE_URL}?s=${serial}`,
                    method: 'GET',
                    timeout: 10000,
                    success: function(firmware) {
                        console.log('API response for', serial, ':', firmware);
                        
                        // Check if device already exists
                        const existingDeviceIndex = deviceData.findIndex(device => device.serial === serial);
                        
                        if (existingDeviceIndex !== -1) {
                            // Update existing device
                            console.log('Updating existing device:', serial);
                            deviceData[existingDeviceIndex].firmware = firmware;
                            deviceData[existingDeviceIndex].isLatest = firmware === LATEST_FIRMWARE;
                            deviceData[existingDeviceIndex].lastUpdate = new Date().toLocaleString('vi-VN');
                            
                            saveDataToStorage();
                            renderTable();
                            
                            // Show appropriate message based on firmware status
                            if (firmware === LATEST_FIRMWARE) {
                                showAlert('Đã cập nhật', 'success', serial);
                            } else {
                                showAlert('Chưa cập nhật', 'warning', serial);
                            }
                        } else {
                            // Add new device
                            console.log('Adding new device:', serial);
                            const device = {
                                serial: serial,
                                firmware: firmware,
                                isLatest: firmware === LATEST_FIRMWARE,
                                lastUpdate: new Date().toLocaleString('vi-VN')
                            };
                            
                            console.log('Device object created:', device);
                            deviceData.unshift(device);
                            saveDataToStorage();
                            renderTable();
                            
                            // Show appropriate message based on firmware status
                            if (firmware === LATEST_FIRMWARE) {
                                showAlert('Đã cập nhật', 'success', serial);
                            } else {
                                showAlert('Chưa cập nhật', 'warning', serial);
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log('API error for', serial, ':', error);
                        showAlert(`Lỗi khi kiểm tra firmware cho ${serial}: ${error}`, 'danger');
                    },
                    complete: function() {
                        showLoading(false);
                    }
                });
            }

            // Recheck firmware for a device
            function recheckFirmware(serial) {
                const deviceIndex = deviceData.findIndex(device => device.serial === serial);
                if (deviceIndex === -1) return;
                
                showLoading(true);
                $.ajax({
                    url: `${API_BASE_URL}?s=${serial}`,
                    method: 'GET',
                    timeout: 10000,
                    success: function(firmware) {
                        deviceData[deviceIndex].firmware = firmware;
                        deviceData[deviceIndex].isLatest = firmware === LATEST_FIRMWARE;
                        deviceData[deviceIndex].lastUpdate = new Date().toLocaleString('vi-VN');
                        
                        saveDataToStorage();
                        renderTable();
                        showAlert(`Đã cập nhật firmware cho ${serial}: ${firmware}`, 'success');
                    },
                    error: function(xhr, status, error) {
                        showAlert(`Lỗi khi kiểm tra lại firmware cho ${serial}: ${error}`, 'danger');
                    },
                    complete: function() {
                        showLoading(false);
                    }
                });
            }

            // Delete device
            function deleteDevice(serial) {
                if (confirm(`Bạn có chắc chắn muốn xóa thiết bị ${serial}?`)) {
                    deviceData = deviceData.filter(device => device.serial !== serial);
                    saveDataToStorage();
                    renderTable();
                    showAlert(`Đã xóa thiết bị ${serial}`, 'info');
                }
            }

            // Render table
            function renderTable() {
                const tbody = $('#deviceTableBody');
                tbody.empty();
                
                if (deviceData.length === 0) {
                    $('#emptyState').show();
                    return;
                }
                
                $('#emptyState').hide();
                
                deviceData.forEach((device, index) => {
                    const stt = deviceData.length - index; // STT giảm dần (mới nhất = STT cao nhất)
                    const row = $(`
                        <tr>
                            <td><span class="badge bg-primary">${stt}</span></td>
                            <td><code>${device.serial}</code></td>
                            <td><span class="badge bg-secondary">${device.firmware}</span></td>
                            <td>${getLatestStatusBadge(device.isLatest)}</td>
                            <td><small class="text-muted">${device.lastUpdate}</small></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="recheckFirmware('${device.serial}')" title="Kiểm tra lại">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteDevice('${device.serial}')" title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                    tbody.append(row);
                });
            }

            // Get latest status badge
            function getLatestStatusBadge(isLatest) {
                if (isLatest) {
                    return '<span class="badge bg-success status-badge"><i class="fas fa-check"></i> Latest</span>';
                } else {
                    return '<span class="badge bg-warning status-badge"><i class="fas fa-exclamation-triangle"></i> Outdated</span>';
                }
            }

            // Show loading state
            function showLoading(show) {
                $('.loading').toggle(show);
            }

            // Show alert message
            function showAlert(message, type, serial = null) {
                // Remove existing toast notifications
                $('.toast-notification').remove();
                
                // Determine icon and colors based on type
                let icon, bgClass, textClass;
                
                if (type === 'success') {
                    icon = '<i class="fas fa-check-circle"></i>';
                    bgClass = 'alert-success';
                    textClass = 'text-dark';
                } else if (type === 'warning') {
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    bgClass = 'alert-warning';
                    textClass = 'text-dark';
                } else if (type === 'danger') {
                    icon = '<i class="fas fa-times-circle"></i>';
                    bgClass = 'alert-danger';
                    textClass = 'text-white';
                } else {
                    icon = '<i class="fas fa-info-circle"></i>';
                    bgClass = 'alert-info';
                    textClass = 'text-white';
                }
                
                // Create toast notification with new format
                const toastHtml = `
                    <div class="toast-notification alert ${bgClass} alert-dismissible fade show" role="alert">
                        <div class="${textClass}">
                            <div class="toast-icon">${icon}</div>
                            <div class="toast-message">${message}</div>
                            ${serial ? `<div class="toast-serial">${serial}</div>` : ''}
                        </div>
                        <button type="button" class="btn-close" onclick="closeToast(this)"></button>
                    </div>
                `;
                
                // Add toast to body
                $('body').append(toastHtml);
                
                // Auto dismiss after 2 seconds
                setTimeout(() => {
                    const toast = $('.toast-notification');
                    if (toast.length > 0) {
                        toast.addClass('fade-out');
                        setTimeout(() => {
                            toast.remove();
                        }, 300);
                    }
                }, 2000);
            }

            // Close toast notification
            function closeToast(button) {
                const toast = $(button).closest('.toast-notification');
                toast.addClass('fade-out');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }

            // Save data to localStorage
            function saveDataToStorage() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(deviceData));
            }

            // Load data from localStorage
            function loadDataFromStorage() {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    try {
                        deviceData = JSON.parse(stored);
                    } catch (e) {
                        console.error('Error parsing stored data:', e);
                        deviceData = [];
                    }
                }
            }

            // Clear all data
            function clearAllData() {
                if (deviceData.length === 0) {
                    showAlert('Không có dữ liệu để xóa!', 'info');
                    return;
                }
                
                const confirmMessage = `Bạn có chắc chắn muốn xóa TẤT CẢ ${deviceData.length} thiết bị?\n\nHành động này không thể hoàn tác!`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                // Double confirmation for safety
                if (!confirm('Lần cuối cùng - Bạn có thực sự muốn xóa tất cả dữ liệu?')) {
                    return;
                }
                
                console.log('Clearing all data:', deviceData.length, 'devices');
                
                // Clear device data
                deviceData = [];
                
                // Clear localStorage
                localStorage.removeItem(STORAGE_KEY);
                
                // Refresh table
                renderTable();
                
                // Show success message
                showAlert('Đã xóa tất cả dữ liệu thành công!', 'success');
                
                console.log('All data cleared successfully');
            }

            // Export data to JSON file
            function exportToJson() {
                if (deviceData.length === 0) {
                    showAlert('Không có dữ liệu để export!', 'warning');
                    return;
                }
                
                // Create export data with metadata
                const exportData = {
                    exportInfo: {
                        timestamp: new Date().toISOString(),
                        totalDevices: deviceData.length,
                        latestFirmware: LATEST_FIRMWARE,
                        exportedBy: 'Firmware Check Tool'
                    },
                    devices: deviceData
                };
                
                // Convert to JSON string with pretty formatting
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // Create blob and download
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Create download link
                const link = document.createElement('a');
                link.href = url;
                link.download = `firmware-check-${new Date().toISOString().split('T')[0]}.json`;
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up URL object
                URL.revokeObjectURL(url);
                
                console.log('Exported data:', exportData);
                showAlert(`Đã export ${deviceData.length} thiết bị ra file JSON!`, 'success');
            }

            // Recheck all outdated devices
            function recheckAllOutdated() {
                const outdatedDevices = deviceData.filter(device => !device.isLatest);
                
                if (outdatedDevices.length === 0) {
                    showAlert('Không có thiết bị nào cần kiểm tra lại!', 'info');
                    return;
                }
                
                if (!confirm(`Bạn có chắc chắn muốn kiểm tra lại ${outdatedDevices.length} thiết bị outdated?`)) {
                    return;
                }
                
                console.log('Bắt đầu recheck tất cả thiết bị outdated:', outdatedDevices.length);
                showLoading(true);
                
                let completedCount = 0;
                let successCount = 0;
                let errorCount = 0;
                
                outdatedDevices.forEach((device, index) => {
                    setTimeout(() => {
                        console.log(`Rechecking device ${index + 1}/${outdatedDevices.length}:`, device.serial);
                        
                        $.ajax({
                            url: `${API_BASE_URL}?s=${device.serial}`,
                            method: 'GET',
                            timeout: 10000,
                            success: function(firmware) {
                                console.log(`API response for ${device.serial}:`, firmware);
                                
                                // Find device in array and update
                                const deviceIndex = deviceData.findIndex(d => d.serial === device.serial);
                                if (deviceIndex !== -1) {
                                    deviceData[deviceIndex].firmware = firmware;
                                    deviceData[deviceIndex].isLatest = firmware === LATEST_FIRMWARE;
                                    deviceData[deviceIndex].lastUpdate = new Date().toLocaleString('vi-VN');
                                    successCount++;
                                }
                            },
                            error: function(xhr, status, error) {
                                console.log(`API error for ${device.serial}:`, error);
                                errorCount++;
                            },
                            complete: function() {
                                completedCount++;
                                
                                // Check if all requests completed
                                if (completedCount === outdatedDevices.length) {
                                    saveDataToStorage();
                                    renderTable();
                                    showLoading(false);
                                    
                                    const message = `Hoàn thành kiểm tra ${outdatedDevices.length} thiết bị. Thành công: ${successCount}, Lỗi: ${errorCount}`;
                                    showAlert(message, successCount > 0 ? 'success' : 'warning');
                                    
                                    console.log('Recheck completed:', { total: outdatedDevices.length, success: successCount, error: errorCount });
                                }
                            }
                        });
                    }, index * 500); // Delay 500ms between requests to avoid overwhelming the API
                });
            }

            // Make functions globally available
            window.recheckFirmware = recheckFirmware;
            window.deleteDevice = deleteDevice;
            window.recheckAllOutdated = recheckAllOutdated;
            window.clearAllData = clearAllData;
            window.exportToJson = exportToJson;
            window.closeToast = closeToast;
        });
    </script>
</body>
</html>
